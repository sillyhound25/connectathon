<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script src="js/jquery-1.9.0.min.js"></script>
    <script src="js/handlebars-v1.3.0.js"></script>
    <script src="js/underscore-min.js"></script>
    <script src="js/backbone-min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/async.js"></script>
    <script src="js/typeahead.bundle.js"></script>
    <!--<script src="functions.js"></script>
    <script src="testFunctions.js"></script>
    <script src="views/testDataView.js"></script>-->
    <script src="js/views/queryView.js"></script>
    <script src="js/views/ValueSetListView.js"></script>
    <script src="js/views/ValueSetSummaryView.js"></script>
    <script src="js/views/ValueSetDetailView.js"></script>
    <script src="js/models/ValueSetModel.js"></script>


    <script src="js/views/ProfileListView.js"></script>
    <script src="js/views/ProfileDetailView.js"></script>
    <script src="js/views/ProfileExtensionView.js"></script>
    <script src="js/views/ProfileSummaryView.js"></script>
    <script src="js/views/ProfileTestFormView.js"></script>
    <script src="js/models/ProfileModel.js"></script>
    <script src="js/models/ProfileSummaryModel.js"></script>
    <script src="js/models/ProfileTestFormModel.js"></script>
    <script src="js/collections/ProfileCollection.js"></script>
    <script src="js/collections/ValueSetCollection.js"></script>
    <!-- Latest compiled and minified CSS-->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <!-- Optional theme -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>


</head>
<body style="padding: 8px">

<div id='loading' class="alert alert-warning">Loading...</div>

<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <a class="navbar-brand" href="#">
            <img src="images/icon-fhir-32.png"/>
            </a>
            <a class="navbar-brand" href="#">  FHIR Profile Editor</a>
        </div>
        <ul class="nav navbar-nav">
            <li class=" navMainOption" data-page='homeTab'><a href="#"><i class="glyphicon glyphicon-home"></i> Home</a> </li>
            <li class="active navMainOption" data-page='profileTab'><a href="#" ><i class="glyphicon glyphicon-file"></i> Profiles</a></li>
            <li class=" navMainOption" data-page='vsTab'><a href="#"><i class="glyphicon glyphicon-list"></i>  ValueSet</a></li>
            <li class="navMainOption" data-page='queryTab'><a href="#"><i class="glyphicon glyphicon-fire"></i>  Search</a></li>
        </ul>
        <ul class="nav navbar-nav pull-right">
            <li class="navMainOption" data-page='helpTab'><a href="#" ><i class="glyphicon glyphicon-question-sign"></i> </a></li>
        </ul>
    </div>
</nav>

<div class="container-fluid">

    <div>
        <div class="myPane" id="homeTab">
            <!--<div class="bg-primary container text-center"> <h2>Orion Profile and ValueSet editor</h2></div>-->
            <p>This application allows you to view and edit the profiles and valueSets created to support the
            Orion FHIR interfaces. It is very much a sub-set of the full capability of these resources, and so cannot display
            every profile - only those generated by this tool, or that only utilize the same subset as this tool</p>

            <p>If you are new to the concept of FHIR and profiles, then there are a number of resources available</p>
            <ul>
                <li>The <a target="_blank" href='http://hl7.org/implement/standards/fhir/'>FHIR specification</a> is the definitive source of truth for FHIR</li>
                <li>There's a <a target="_blank"  href='http://vimeo.com/87074652'>video</a> by Ewout Kramer (one of the FHIR core team) on the reason for profiles</li>
                <li>David Hay has a blog on FHIR (look in the <a target="_blank" href='http://fhirblog.com/index/'>index</a> for Profile specific posts)</li>
            </ul>

            <p>Click on the help icon to the upper right for more information about the tool</p>

            <h5>Assumptions</h5>
            <ul>
                <li>The Profile extensions are only against resources (not datatypes) and only for a single resource</li>
                <li>Assume that the profiles only use ValueSets published by Orion</li>
                <li>Assume that the reference to a valueset is to an external one - no Contained sets</li>
                <li>Assume that the Orion ValueSets have a unique name property</li>
            </ul>
        </div>

        <div class="myPane" id="profileTab">
            <div class="row">
                <div class="col-md-2 well">
                    <h4>Resources</h4>
                    <ul class="list-unstyled" id="coreResourceList">
                        <!--<li><a class="selProfile" data-name="patient" data-pub='FHIR Project'>Patient</a></li>-->
                    </ul>

                    <h4>Orion Profiles</h4>
                    <div id="orionProfilesDiv"></div>
                </div>

                <div class="col-md-10">
                    <!--
                                        <div id="workAreaProfile"></div>-->

                    <ul class="nav nav-tabs">
                        <li class="pull-right"><a href="#profileTestDataSubTab" data-toggle="tab">Test Data</a></li>
                        <li class="pull-right"><a href="#profileSummarySubTab" data-toggle="tab">Summary</a></li>
                        <li class="active pull-right"><a href="#profileDetailSubTab" data-toggle="tab">Detail</a></li>

                    </ul>

                    <div class="tab-content">


                        <div class="tab-pane active" id="profileDetailSubTab">
                            <h4>Profile Detail</h4>
                            <div id="workAreaProfile"></div>
                        </div>

                        <div class="tab-pane" id="profileSummarySubTab">
                            <!--<button  class="btn btn-success pull-right" id="btnCreateSummaryXXX">Generate summary</button>-->

                            <div id='updatingProfileSummaryMsg' style="display:none" class="alert alert-warning">Reading data for the summary. This can take a while...</div>

                            <div id="workAreaSummaryProfile"></div>
                        </div>

                        <div class="tab-pane" id="profileTestDataSubTab">

                            <!--<h4>Generate Test Data</h4>-->

                            <div id="workAreaTestData"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="myPane" id="vsTab">
            <div class="row">
                <div class="col-md-2 well">
                    <h4>ValueSets</h4>
                    <div id="display"></div>
                </div>
                <div class="col-md-10">
                    <h4>ValueSet Detail</h4>
                    <div id="workAreaVS"></div>
                </div>
            </div>

        </div>

        <div class="myPane" id="queryTab">
            <div class="row">
                <div id="workAreaQuery"></div>
                <!--
                <div class="col-md-2 well well-sm">
                    <h4>Resources</h4>
                    <div id="qry_display"></div>
                </div>
                <div class="col-md-10">
                    <h4></h4>
                    <div id="workAreaQuery"></div>
                </div>
                -->

            </div>

        </div>



        <div class="myPane" id = "helpTab">
            <iframe id="myIFrame" style="width: 1200px; height:600px"></iframe>
        </div>

    </div>


    <div id="editExtensionDiv"></div>
    <div id="modalDialogDiv"></div>
</div>

<script>

    $(document).ready(function(){
        /*
        var Z = {template:{},localFunctions : {},views:{}};     //instead of Y

        //load all the handlebars templates from the templates folder...
        $.each(['oneVS','listVS','oneProfile','orionProfileList','editExtension','profileSummary'],function(inx,name){
            var fileName = 'templates/'+name+'.html';
            $.get(fileName,function(html){
                Z.template[name] = Handlebars.compile(html);
            })
        })


        //list of resources - should be the complete fhir list...
        Z.resourceList = ['Encounter','MedicationAdministration','Medication','Observation','Patient','Practitioner'];
        $.each(Z.resourceList,function(inx,res){
            var lne = "<li><a class='selProfile' data-name='"+res+"' data-pub='FHIR Project'>"+res+"</a></li>";
            $('#coreResourceList').append(lne);
        })

        */

        //Z.dataTypeList = ['boolean','code','string','integer','Coding','CodeableConcept','Period']

        //the list of permissable datatypes in a profile...
        var dataTypeList = ['boolean','code','date','string','integer','Coding','CodeableConcept','Period']
        var resourceList = ['Encounter','MedicationAdministration','Medication','Observation','Patient','Practitioner'];


        //======== Using Mediator pattern via global BackBone object ================

        //============================== ValueSet objects and handlers ==========================
        var colVS = new ValueSetCollection();           //collection of ValueSets
        var listVS = new ValueSetListView({collection:colVS,el:$('#display')}); //List View for the ValueSets
        var vsDetailView = new ValueSetDetailView({el:$('#workAreaVS')});       //Detail/edit view for a single VS

        //The user selects a VS in the list
        Backbone.listenTo(listVS,'vsList:select',function(vo){
            //see if the existing valueset has been changed...
            var canShowVS = true;
            if (vsDetailView.hasChanged()) {
                canShowVS = confirm("There are unsaved changes. Are you sure you wish to continue?")
            }
            if (canShowVS) {
                var selectedModel = colVS.findModelByResourceID(vo.id);       //the vs selected in the list view
                vsDetailView.model = selectedModel;
                vsDetailView.render();
            }
        });

        //the handler when the option to create a new ValueSet is selected
        Backbone.listenTo(listVS,'vsList:new',function(vo){
            vsDetailView.setNewValueSet();
            vsDetailView.render();
        })

        //load the ValueSet. At the moment this is only Orion sourced resources... - Later we'll allow a select of some sort
        //display the list when finished...
        colVS.fetch({
            success : function() {
                $('#loading').hide();
                listVS.render();      //render the list of valuesets...
            },
            error : function() {
                alert('There was an error loading the ValueSets')
            }
        });

        //============================= Profile objects and handlers

        var colProfile = new ProfileCollection();
        var listProfiles = new ProfileListView({collection:colProfile,el:$('#orionProfilesDiv')}); //List View for the Profiles
        var profileDetailView = new ProfileDetailView({el:$('#workAreaProfile')});       //Detail/edit view for a single VS
        var profileExtensionView = new ProfileExtensionView({el:$('#editExtensionDiv')});
        //todo - these should probably be a method on the View rather than a direct setting like this...
        profileExtensionView.meta.dataTypeList = dataTypeList;      //the permissable datatypes
        profileExtensionView.meta.colVS = colVS;    //the collection of known valuesets (or at least, those we can choose from)
        profileExtensionView.meta.resourceList = resourceList;

        var profileSummaryView = new ProfileSummaryView({el:$('#workAreaSummaryProfile')});       //generate a profile summary
        profileSummaryView.render();

        var profileTestFormView = new ProfileTestFormView({el:$('#workAreaTestData')});       //generate a test form...
        profileTestFormView.meta.colVS = colVS;    //needse the valueset
        profileTestFormView.render();   //as there is no model, this will just render the 'create form' button...

        var valueSetSummaryView = new ValueSetSummaryView();

        //The user selects a Profile from the  in the list. Make sure that all the views that have an interest in
        //this profile have their model set...
        Backbone.listenTo(listProfiles,'profileList:select',function(vo){
            var selectedModel = colProfile.findModelByResourceID(vo.id);       //the vs selected in the list view
            profileDetailView.setModel(selectedModel);
            profileSummaryView.model = selectedModel;
            profileTestFormView.model = selectedModel;


            profileDetailView.render();
        });

        //a new profile
        Backbone.listenTo(listProfiles,'profileList:new',function(vo){
            profileDetailView.model = null;     //this means no model - ie new...
            profileDetailView.render();
        })

        //handler for when a user clicks on an existing extension definition in a profile
        Backbone.listenTo(profileDetailView,'profileDetail:editExtension',function(vo){
            console.log(vo);
            var selectedModel = colProfile.findModelByResourceID(vo.id);       //the vs selected in the list view

            profileExtensionView.model = selectedModel;
            profileExtensionView.setCode(vo.code);
            profileExtensionView.render();

        });

        //handler for when a new extension is to be added to a profile
        Backbone.listenTo(profileDetailView,'profileDetail:addExtension',function(vo){
            console.log(vo);
            var selectedModel = colProfile.findModelByResourceID(vo.id);       //the vs selected in the list view
            profileExtensionView.model = selectedModel;
            profileExtensionView.setCode("");   //an empty code will mean a new extension...
            profileExtensionView.render();

        });

        //the user wishes to view a valueset...
        Backbone.listenTo(profileDetailView,'profileDetail:showVS',function(vo){
            valueSetSummaryView.render(vo.uri)
        })


        //a new profile was added
        Backbone.listenTo(profileDetailView,'profile:added',function(vo){
            console.log(vo);
            //re-read all the models. May be able to add it to the collection directly...
            colProfile.fetch({
                success : function() {
                    $('#loading').hide();
                    listProfiles.render();      //render the list of valuesets...
                },
                error : function() {
                    alert('There was an error loading the Profiles')
                }
            });

            //colProfile.add(vo.model);
            //listProfiles.render();      //re-display the vi
        });

        //an extension in a profile has been updated.
        Backbone.listenTo(profileExtensionView,'profileExtension:updated',function(vo){
            //re-render the profile - the model should already be set...
            profileDetailView.render();
        });

        Backbone.listenTo(profileDetailView,'profile:updated',function(vo){
            //re-render the profile - the model should already be set...
            profileDetailView.render();
        });



        colProfile.fetch({
            success : function() {
                $('#loading').hide();
                //_.each(colProfile.models,function(m){
                //    console.log(m.id);
               // })
                //console.log(colProfile.models);
                listProfiles.render();      //render the list of valuesets...
            },
            error : function() {
                alert('There was an error loading the Profiles')
            }
        });


        var viewQuery = new QueryView({el:$('#workAreaQuery')});
        viewQuery.render();


        ///Z.views.viewQuery = new QueryView({el:$('#workAreaQuery')});
        //Z.views.viewQuery.render();



/* temp

        //set up the iframe within which help is shown
        $('#myIFrame').attr('src','http://fhirprofileeditor.wordpress.com/overview/');
        $('#myIFrame').attr('width',$( window ).width());


        */
        //activate the navbar tags...
        $('.myPane').hide();        //initially hide all the panes...
        //$('#homeTab').show();       //show the home tab
        $('#profileTab').show();       //show the profile tab




        $(".navMainOption").on('click',function(ev){
            //toggle the navbar links...
            $(".navMainOption").removeClass('active');
            $(ev.currentTarget).addClass('active');

            //show the appropriate pane...
            $('.myPane').hide();
            var paneToShow = ev.currentTarget.getAttribute('data-page')
            //console.log(paneToShow)
            $('#'+paneToShow).show();
        })

    })


/*


function showCurrentProfile(Z) {
    //use the BS template to lay out the profile...







    //the handler for when the valueSet detail link is selected.
    $('.vsInExt').on('click',function(ev){
        var vsURI = ev.currentTarget.getAttribute('data-code');
        //alert(encodeURIComponent(vsURI));

        //get teh resource. Note this is the actual resource - not a bundle.entry
        $.get( "/api/valueset/id/"+encodeURIComponent(vsURI), function( vsResource ) {
            //alert(data);
            console.log(vsResource)
            var genDialogFrame = $('#generalModelDlg').html();      //the frams for the modal dialog
            $('#modalDialogDiv').html(genDialogFrame);      //write the frame to the DOM

            var model = {content:vsResource};
            model.id = vsURI;
            model.readOnly = true;

            $('#modal-content').html(Z.template.oneVS(model));    //use the BS template to write out the dialog



            //and show the modal...
            $('#generalDlg').modal();


        });
    })

    //console.log(Z.currentProfile);

    //the handler when an existing extension is selected for editing/display
    $('.profile-extension').on('click',function(ev){
        var code = ev.currentTarget.getAttribute('data-code');      //the code of the extension
        showOneExtension(Z,code);       //displays the modal dialog for editing an extension
    })

}

*/

</script>


<script id="generalModelDlg" type="text/x-handlebars-template">
    <div class="modal fade" id="generalDlg">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title"><span id="generalDlgTitle">General Dialog</span></h4>
                </div>
                <div class="modal-body">
                    <div id='modal-content'></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

</script>






</body>
</html>